import io
import openpyxl
from openpyxl.styles import Font, PatternFill, Alignment
from reportlab.lib.pagesizes import letter, A4
from reportlab.lib import colors
from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
from reportlab.platypus import SimpleDocTemplate, Table, TableStyle, Paragraph, Spacer
from reportlab.pdfgen import canvas
from reportlab.lib.units import inch
from django.http import HttpResponse
from django.utils import timezone
from django.db.models import Sum, Avg, Count
from .models import Producto, Categoria
import os
from django.conf import settings

class ExcelExporter:
    """Exportador de datos a Excel con formato profesional"""
    
    @staticmethod
    def export_productos_excel():
        """Exportar todos los productos a Excel"""
        # Crear libro de trabajo
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = "Productos"
        
        # Estilos
        header_font = Font(bold=True, color="FFFFFF")
        header_fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        center_align = Alignment(horizontal="center", vertical="center")
        
        # Encabezados
        headers = ['ID', 'Nombre', 'Descripción', 'Precio', 'Categoría', 'Stock', 'Estado', 'Fecha Creación']
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = header_font
            cell.fill = header_fill
            cell.alignment = center_align
        
        # Datos de productos
        productos = Producto.objects.all().select_related('categoria')
        for row, producto in enumerate(productos, 2):
            estado = "Disponible" if producto.stock > 10 else "Stock Bajo" if producto.stock > 0 else "Agotado"
            
            ws.cell(row=row, column=1, value=producto.id)
            ws.cell(row=row, column=2, value=producto.nombre)
            ws.cell(row=row, column=3, value=producto.descripcion or "")
            ws.cell(row=row, column=4, value=float(producto.precio))
            ws.cell(row=row, column=5, value=producto.categoria.nombre)
            ws.cell(row=row, column=6, value=producto.stock)
            ws.cell(row=row, column=7, value=estado)
            ws.cell(row=row, column=8, value=producto.fecha_creacion.strftime("%d/%m/%Y %H:%M"))
        
        # Autoajustar columnas
        for column in ws.columns:
            max_length = 0
            column_letter = column[0].column_letter
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = min(max_length + 2, 50)
            ws.column_dimensions[column_letter].width = adjusted_width
        
        # Hoja de estadísticas
        ws_stats = wb.create_sheet("Estadísticas")
        
        # Estadísticas generales
        stats_headers = ['Métrica', 'Valor']
        for col, header in enumerate(stats_headers, 1):
            cell = ws_stats.cell(row=1, column=col, value=header)
            cell.font = header_font
            cell.fill = header_fill
        
        stats_data = [
            ['Total Productos', Producto.objects.count()],
            ['Total Categorías', Categoria.objects.count()],
            ['Stock Total', Producto.objects.aggregate(total=Sum('stock'))['total'] or 0],
            ['Precio Promedio', round(Producto.objects.aggregate(avg=Avg('precio'))['avg'] or 0, 2)],
            ['Productos con Stock Alto', Producto.objects.filter(stock__gt=10).count()],
            ['Productos con Stock Bajo', Producto.objects.filter(stock__range=(1, 10)).count()],
            ['Productos Agotados', Producto.objects.filter(stock=0).count()],
        ]
        
        for row, (metric, value) in enumerate(stats_data, 2):
            ws_stats.cell(row=row, column=1, value=metric)
            ws_stats.cell(row=row, column=2, value=value)
        
        # Crear respuesta
        buffer = io.BytesIO()
        wb.save(buffer)
        buffer.seek(0)
        
        return buffer

    @staticmethod
    def export_categorias_excel():
        """Exportar categorías con estadísticas a Excel"""
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = "Categorías"
        
        # Estilos
        header_font = Font(bold=True, color="FFFFFF")
        header_fill = PatternFill(start_color="70AD47", end_color="70AD47", fill_type="solid")
        
        # Encabezados
        headers = ['Categoría', 'Total Productos', 'Stock Total', 'Precio Promedio', 'Productos con Stock Bajo']
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=1, column=col, value=header)
            cell.font = header_font
            cell.fill = header_fill
        
        # Datos de categorías
        categorias = Categoria.objects.annotate(
            total_productos=Count('productos'),
            total_stock=Sum('productos__stock'),
            precio_promedio=Avg('productos__precio')
        )
        
        for row, categoria in enumerate(categorias, 2):
            productos_bajo_stock = categoria.productos.filter(stock__lt=10).count()
            
            ws.cell(row=row, column=1, value=categoria.nombre)
            ws.cell(row=row, column=2, value=categoria.total_productos)
            ws.cell(row=row, column=3, value=categoria.total_stock or 0)
            ws.cell(row=row, column=4, value=round(categoria.precio_promedio or 0, 2))
            ws.cell(row=row, column=5, value=productos_bajo_stock)
        
        # Autoajustar columnas
        for column in ws.columns:
            max_length = 0
            column_letter = column[0].column_letter
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = min(max_length + 2, 30)
            ws.column_dimensions[column_letter].width = adjusted_width
        
        buffer = io.BytesIO()
        wb.save(buffer)
        buffer.seek(0)
        
        return buffer

    @staticmethod
    def export_inventario_excel():
        """Exportar reporte completo de inventario a Excel"""
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = "Inventario Completo"
        
        # Estilos mejorados
        header_font = Font(bold=True, color="FFFFFF", size=12)
        header_fill = PatternFill(start_color="2C3E50", end_color="2C3E50", fill_type="solid")
        warning_fill = PatternFill(start_color="F39C12", end_color="F39C12", fill_type="solid")
        danger_fill = PatternFill(start_color="E74C3C", end_color="E74C3C", fill_type="solid")
        
        # Título principal
        ws.merge_cells('A1:H1')
        title_cell = ws.cell(row=1, column=1, value="REPORTE DE INVENTARIO COMPLETO - MI TIENDA PREMIUM")
        title_cell.font = Font(bold=True, size=14, color="2C3E50")
        title_cell.alignment = Alignment(horizontal="center")
        
        # Fecha de generación
        ws.merge_cells('A2:H2')
        fecha_cell = ws.cell(row=2, column=1, value=f"Generado el: {timezone.now().strftime('%d/%m/%Y %H:%M')}")
        fecha_cell.alignment = Alignment(horizontal="center")
        fecha_cell.font = Font(italic=True, color="7F8C8D")
        
        # Encabezados de tabla
        headers = ['ID', 'Producto', 'Categoría', 'Precio', 'Stock', 'Estado', 'Valor Total', 'Última Actualización']
        for col, header in enumerate(headers, 1):
            cell = ws.cell(row=4, column=col, value=header)
            cell.font = header_font
            cell.fill = header_fill
            cell.alignment = Alignment(horizontal="center", vertical="center")
        
        # Datos de productos
        productos = Producto.objects.all().select_related('categoria').order_by('-stock', 'categoria__nombre')
        total_valor_inventario = 0
        
        for row, producto in enumerate(productos, 5):
            # Determinar estado y estilo
            if producto.stock > 10:
                estado = "ALTO"
                estado_fill = None
            elif producto.stock > 0:
                estado = "BAJO"
                estado_fill = warning_fill
            else:
                estado = "AGOTADO"
                estado_fill = danger_fill
            
            valor_total = float(producto.precio) * producto.stock
            total_valor_inventario += valor_total
            
            # Escribir datos
            ws.cell(row=row, column=1, value=producto.id)
            ws.cell(row=row, column=2, value=producto.nombre)
            ws.cell(row=row, column=3, value=producto.categoria.nombre)
            ws.cell(row=row, column=4, value=float(producto.precio))
            ws.cell(row=row, column=5, value=producto.stock)
            
            estado_cell = ws.cell(row=row, column=6, value=estado)
            if estado_fill:
                estado_cell.fill = estado_fill
            
            ws.cell(row=row, column=7, value=valor_total)
            ws.cell(row=row, column=8, value=producto.fecha_creacion.strftime("%d/%m/%Y"))
        
        # Resumen al final
        summary_row = len(productos) + 6
        ws.cell(row=summary_row, column=6, value="VALOR TOTAL INVENTARIO:").font = Font(bold=True)
        ws.cell(row=summary_row, column=7, value=total_valor_inventario).font = Font(bold=True, color="27AE60")
        
        # Autoajustar columnas
        for column in ws.columns:
            max_length = 0
            column_letter = column[0].column_letter
            for cell in column:
                try:
                    if len(str(cell.value)) > max_length:
                        max_length = len(str(cell.value))
                except:
                    pass
            adjusted_width = min(max_length + 2, 50)
            ws.column_dimensions[column_letter].width = adjusted_width
        
        buffer = io.BytesIO()
        wb.save(buffer)
        buffer.seek(0)
        
        return buffer

class PDFExporter:
    """Exportador de datos a PDF con diseño profesional"""
    
    @staticmethod
    def export_productos_pdf():
        """Exportar productos a PDF"""
        buffer = io.BytesIO()
        doc = SimpleDocTemplate(buffer, pagesize=A4, topMargin=1*inch)
        elements = []
        
        # Estilos
        styles = getSampleStyleSheet()
        title_style = ParagraphStyle(
            'CustomTitle',
            parent=styles['Heading1'],
            fontSize=16,
            spaceAfter=30,
            alignment=1,
            textColor=colors.HexColor('#2c3e50')
        )
        
        # Título
        title = Paragraph("REPORTE DE PRODUCTOS - MI TIENDA PREMIUM", title_style)
        elements.append(title)
        
        # Información del reporte
        fecha = timezone.now().strftime("%d/%m/%Y %H:%M")
        info_text = f"<b>Fecha de generación:</b> {fecha} | <b>Total productos:</b> {Producto.objects.count()}"
        info = Paragraph(info_text, styles["Normal"])
        elements.append(info)
        elements.append(Spacer(1, 20))
        
        # Tabla de productos
        data = [['Nombre', 'Precio', 'Categoría', 'Stock', 'Estado']]
        
        productos = Producto.objects.all().select_related('categoria')[:50]
        
        for producto in productos:
            estado = "Disponible" if producto.stock > 10 else "Stock Bajo" if producto.stock > 0 else "Agotado"
            
            data.append([
                producto.nombre[:30] + "..." if len(producto.nombre) > 30 else producto.nombre,
                f"${producto.precio}",
                producto.categoria.nombre,
                str(producto.stock),
                estado
            ])
        
        # Crear tabla
        table = Table(data, colWidths=[2.5*inch, 1*inch, 1.5*inch, 0.8*inch, 1.2*inch])
        table.setStyle(TableStyle([
            ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#34495e')),
            ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
            ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
            ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
            ('FONTSIZE', (0, 0), (-1, 0), 12),
            ('BOTTOMPADDING', (0, 0), (-1, 0), 12),
            ('BACKGROUND', (0, 1), (-1, -1), colors.beige),
            ('FONTNAME', (0, 1), (-1, -1), 'Helvetica'),
            ('FONTSIZE', (0, 1), (-1, -1), 10),
            ('GRID', (0, 0), (-1, -1), 1, colors.black),
            ('ROWBACKGROUNDS', (0, 1), (-1, -1), [colors.white, colors.lightgrey]),
        ]))
        
        elements.append(table)
        elements.append(Spacer(1, 20))
        
        # Estadísticas resumen
        stats_style = ParagraphStyle(
            'StatsStyle',
            parent=styles["Normal"],
            fontSize=10,
            textColor=colors.HexColor('#7f8c8d')
        )
        
        total_productos = Producto.objects.count()
        stock_alto = Producto.objects.filter(stock__gt=10).count()
        stock_bajo = Producto.objects.filter(stock__range=(1, 10)).count()
        sin_stock = Producto.objects.filter(stock=0).count()
        precio_promedio = Producto.objects.aggregate(avg=Avg('precio'))['avg'] or 0
        
        stats_text = f"""
        <b>RESUMEN ESTADÍSTICO:</b><br/>
        • Productos con stock alto: <b>{stock_alto}</b><br/>
        • Productos con stock bajo: <b>{stock_bajo}</b><br/>
        • Productos agotados: <b>{sin_stock}</b><br/>
        • Precio promedio: <b>${round(precio_promedio, 2)}</b><br/>
        • Total en inventario: <b>{total_productos} productos</b>
        """
        
        stats = Paragraph(stats_text, stats_style)
        elements.append(stats)
        
        # Generar PDF
        doc.build(elements)
        buffer.seek(0)
        
        return buffer

    @staticmethod
    def export_inventario_pdf():
        """Exportar reporte de inventario detallado"""
        buffer = io.BytesIO()
        doc = SimpleDocTemplate(buffer, pagesize=A4)
        elements = []
        
        styles = getSampleStyleSheet()
        
        # Título
        title = Paragraph("REPORTE DE INVENTARIO DETALLADO", styles["Heading1"])
        elements.append(title)
        elements.append(Spacer(1, 20))
        
        # Por categorías
        categorias = Categoria.objects.annotate(
            total_productos=Count('productos'),
            total_stock=Sum('productos__stock')
        )
        
        for categoria in categorias:
            # Encabezado de categoría
            cat_title = Paragraph(f"Categoría: {categoria.nombre}", styles["Heading2"])
            elements.append(cat_title)
            
            # Productos de la categoría
            productos = categoria.productos.all()
            if productos:
                data = [['Producto', 'Precio', 'Stock', 'Estado']]
                
                for producto in productos:
                    estado = "✓ Disponible" if producto.stock > 10 else "⚠ Bajo" if producto.stock > 0 else "✗ Agotado"
                    data.append([
                        producto.nombre,
                        f"${producto.precio}",
                        producto.stock,
                        estado
                    ])
                
                table = Table(data, colWidths=[3*inch, 1*inch, 1*inch, 1.5*inch])
                table.setStyle(TableStyle([
                    ('BACKGROUND', (0, 0), (-1, 0), colors.HexColor('#3498db')),
                    ('TEXTCOLOR', (0, 0), (-1, 0), colors.whitesmoke),
                    ('ALIGN', (0, 0), (-1, -1), 'CENTER'),
                    ('FONTNAME', (0, 0), (-1, 0), 'Helvetica-Bold'),
                    ('GRID', (0, 0), (-1, -1), 1, colors.black),
                    ('BACKGROUND', (0, 1), (-1, -1), colors.whitesmoke),
                ]))
                
                elements.append(table)
                elements.append(Spacer(1, 10))
            
            # Resumen de categoría
            resumen_text = f"<b>Resumen:</b> {categoria.total_productos} productos | Stock total: {categoria.total_stock or 0}"
            resumen = Paragraph(resumen_text, styles["Normal"])
            elements.append(resumen)
            elements.append(Spacer(1, 20))
        
        doc.build(elements)
        buffer.seek(0)
        return buffer

class ExportManager:
    """Gestor centralizado de exportaciones"""
    
    @staticmethod
    def export_data(export_type, format_type):
        """Exportar datos según tipo y formato"""
        exporters = {
            'productos': {
                'excel': ExcelExporter.export_productos_excel,
                'pdf': PDFExporter.export_productos_pdf,
            },
            'categorias': {
                'excel': ExcelExporter.export_categorias_excel,
                'pdf': PDFExporter.export_inventario_pdf,
            },
            'inventario': {
                'excel': ExcelExporter.export_inventario_excel,
                'pdf': PDFExporter.export_inventario_pdf,
            }
        }
        
        if export_type in exporters and format_type in exporters[export_type]:
            return exporters[export_type][format_type]()
        else:
            raise ValueError(f"Tipo de exportación no válido: {export_type}/{format_type}")

    @staticmethod
    def get_export_stats():
        """Obtener estadísticas para la página de exportación"""
        total_productos = Producto.objects.count()
        total_categorias = Categoria.objects.count()
        
        # Estadísticas de stock
        stock_alto = Producto.objects.filter(stock__gt=10).count()
        stock_bajo = Producto.objects.filter(stock__range=(1, 10)).count()
        sin_stock = Producto.objects.filter(stock=0).count()
        
        # Precio promedio
        precio_promedio = Producto.objects.aggregate(avg=Avg('precio'))['avg'] or 0
        
        return {
            'total_productos': total_productos,
            'total_categorias': total_categorias,
            'stock_alto': stock_alto,
            'stock_bajo': stock_bajo,
            'sin_stock': sin_stock,
            'precio_promedio': round(precio_promedio, 2)
        }