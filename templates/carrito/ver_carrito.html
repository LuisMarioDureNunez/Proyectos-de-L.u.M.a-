{% extends 'base.html' %}
{% load static %}

{% block title %}üõí Mi Carrito - Mi Tienda Premium{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- HEADER MEJORADO -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="hero-section bg-gradient-primary text-white rounded-3 p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-5 fw-bold">
                            <i class="fas fa-shopping-cart me-3"></i>Mi Carrito de Compras
                        </h1>
                        <p class="lead mb-0">Revisa y gestiona tus productos seleccionados</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="bg-white bg-opacity-25 rounded-3 p-3 d-inline-block">
                            <h3 class="mb-0">{{ carrito.cantidad_productos }}</h3>
                            <small class="text-white-50">Productos en carrito</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- LISTA DE PRODUCTOS MEJORADA -->
        <div class="col-lg-8">
            {% if carrito.items.all %}
            <div class="card shadow-lg border-0">
                <div class="card-header bg-transparent border-0 py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0"><i class="fas fa-list me-2"></i>Productos en el Carrito</h3>
                        <span class="badge bg-primary rounded-pill px-3 py-2">
                            {{ carrito.items.count }} items
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th width="45%">Producto</th>
                                    <th class="text-center">Precio Unitario</th>
                                    <th class="text-center" width="15%">Cantidad</th>
                                    <th class="text-center">Subtotal</th>
                                    <th class="text-center" width="10%">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in carrito.items.all %}
                                <tr class="product-row align-middle">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="product-image bg-light rounded-3 me-3 flex-shrink-0" 
                                                 style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                                                {% if item.producto.imagen %}
                                                <img src="{{ item.producto.imagen.url }}" alt="{{ item.producto.nombre }}" 
                                                     class="img-fluid rounded" style="max-height: 60px; object-fit: cover;">
                                                {% else %}
                                                <i class="fas fa-box text-muted fa-2x"></i>
                                                {% endif %}
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-1 fw-bold text-dark">{{ item.producto.nombre }}</h6>
                                                <small class="text-muted d-block">
                                                    <i class="fas fa-tag me-1"></i>{{ item.producto.categoria.nombre }}
                                                </small>
                                                <small class="text-success">
                                                    <i class="fas fa-box me-1"></i>Stock disponible: {{ item.producto.stock }}
                                                </small>
                                                {% if item.cantidad > item.producto.stock %}
                                                <small class="text-danger d-block">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                                    Cantidad excede stock disponible
                                                </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <span class="h5 text-success fw-bold">{{ item.producto.precio|floatformat:0 }} Gs.</span>
                                    </td>
                                    <td class="text-center">
                                        <form method="post" action="{% url 'actualizar_carrito' item.id %}" 
                                              class="d-flex align-items-center justify-content-center">
                                            {% csrf_token %}
                                            <div class="input-group input-group-sm" style="width: 140px;">
                                                <button class="btn btn-outline-secondary border-end-0" type="button" 
                                                        onclick="updateQuantity(this, -1, {{ item.producto.stock }})">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" name="cantidad" value="{{ item.cantidad }}" 
                                                       min="1" max="{{ item.producto.stock }}" 
                                                       class="form-control text-center border-start-0 border-end-0"
                                                       onchange="this.form.submit()">
                                                <button class="btn btn-outline-secondary border-start-0" type="button"
                                                        onclick="updateQuantity(this, 1, {{ item.producto.stock }})">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </form>
                                        <small class="text-muted d-block mt-1">
                                            M√°x: {{ item.producto.stock }}
                                        </small>
                                    </td>
                                    <td class="text-center">
                                        <span class="h4 text-primary fw-bold">{{ item.subtotal|floatformat:0 }} Gs.</span>
                                    </td>
                                    <td class="text-center">
                                        <a href="{% url 'eliminar_del_carrito' item.id %}" 
                                           class="btn btn-danger btn-sm rounded-circle"
                                           onclick="return confirm('¬øEliminar {{ item.producto.nombre }} del carrito?')"
                                           title="Eliminar producto">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- CARRITO VAC√çO MEJORADO -->
            <div class="card shadow-lg border-0 text-center py-5">
                <div class="card-body">
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart fa-5x text-muted mb-4"></i>
                        <h3 class="text-muted mb-3">Tu carrito est√° vac√≠o</h3>
                        <p class="text-muted mb-4">Parece que no has agregado ning√∫n producto a tu carrito todav√≠a.</p>
                        <a href="{% url 'lista_productos' %}" class="btn btn-primary btn-lg rounded-pill px-4 py-2">
                            <i class="fas fa-shopping-bag me-2"></i>Explorar Productos
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- RESUMEN DEL PEDIDO MEJORADO -->
        <div class="col-lg-4">
            {% if carrito.items.all %}
            <div class="card shadow-lg border-0 sticky-top" style="top: 20px;">
                <div class="card-header bg-gradient-success text-white py-3">
                    <h4 class="mb-0"><i class="fas fa-receipt me-2"></i>Resumen del Pedido</h4>
                </div>
                <div class="card-body">
                    <!-- RESUMEN DETALLADO -->
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Detalles del pedido:</h6>
                        {% for item in carrito.items.all %}
                        <div class="d-flex justify-content-between align-items-center mb-2 pb-2 border-bottom">
                            <div class="flex-grow-1">
                                <small class="fw-bold">{{ item.producto.nombre|truncatewords:3 }}</small>
                                <br>
                                <small class="text-muted">{{ item.cantidad }} x {{ item.producto.precio|floatformat:0 }} Gs.</small>
                            </div>
                            <small class="fw-bold text-end">{{ item.subtotal|floatformat:0 }} Gs.</small>
                        </div>
                        {% endfor %}
                    </div>

                    <hr class="my-4">

                    <!-- TOTALES -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="fw-bold">Subtotal:</span>
                            <span class="h5 text-dark fw-bold">{{ carrito.total|floatformat:0 }} Gs.</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Env√≠o:</span>
                            <span class="text-success fw-bold">Gratis</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Impuestos:</span>
                            <span class="text-muted">0 Gs.</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted">Descuento:</span>
                            <span class="text-danger fw-bold">-0 Gs.</span>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- TOTAL FINAL -->
                    <div class="d-flex justify-content-between align-items-center mb-4 p-3 bg-light rounded-3">
                        <span class="h4 mb-0 fw-bold">Total:</span>
                        <span class="h2 text-success fw-bold">{{ carrito.total|floatformat:0 }} Gs.</span>
                    </div>

                    <!-- BOTONES DE ACCI√ìN MEJORADOS -->
                    <div class="d-grid gap-3">
                        <button class="btn btn-success btn-lg rounded-pill py-3 fw-bold">
                            <i class="fas fa-credit-card me-2"></i>Proceder al Pago
                        </button>
                        <a href="{% url 'lista_productos' %}" class="btn btn-outline-primary rounded-pill py-2">
                            <i class="fas fa-arrow-left me-2"></i>Seguir Comprando
                        </a>
                    </div>

                    <!-- GARANT√çAS Y SEGURIDAD -->
                    <div class="mt-4 text-center">
                        <div class="row g-2">
                            <div class="col-4">
                                <small class="text-success">
                                    <i class="fas fa-shield-alt fa-lg d-block mb-1"></i>
                                    Seguro
                                </small>
                            </div>
                            <div class="col-4">
                                <small class="text-info">
                                    <i class="fas fa-truck fa-lg d-block mb-1"></i>
                                    Env√≠o Gratis
                                </small>
                            </div>
                            <div class="col-4">
                                <small class="text-warning">
                                    <i class="fas fa-undo fa-lg d-block mb-1"></i>
                                    Devoluci√≥n
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- PRODUCTOS SUGERIDOS MEJORADOS -->
            <div class="card shadow-lg border-0 mt-4">
                <div class="card-header bg-gradient-info text-white py-3">
                    <h5 class="mb-0"><i class="fas fa-fire me-2"></i>Productos Populares</h5>
                </div>
                <div class="card-body">
                    {% for producto in productos_populares %}
                    <div class="d-flex align-items-center mb-3 p-3 rounded-3 hover-suggestion">
                        <div class="flex-shrink-0">
                            <div class="bg-light rounded-3 d-flex align-items-center justify-content-center" 
                                 style="width: 60px; height: 60px;">
                                {% if producto.imagen %}
                                <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" 
                                     class="img-fluid rounded" style="max-height: 45px; object-fit: cover;">
                                {% else %}
                                <i class="fas fa-box text-muted fa-lg"></i>
                                {% endif %}
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1 fw-bold">{{ producto.nombre|truncatewords:3 }}</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-success fw-bold">{{ producto.precio|floatformat:0 }} Gs.</span>
                                {% if producto.stock > 0 %}
                                <span class="badge bg-success rounded-pill">En stock</span>
                                {% else %}
                                <span class="badge bg-danger rounded-pill">Agotado</span>
                                {% endif %}
                            </div>
                        </div>
                        <a href="{% url 'agregar_al_carrito' producto.id %}" 
                           class="btn btn-outline-primary btn-sm rounded-circle ms-2"
                           title="Agregar al carrito">
                            <i class="fas fa-cart-plus"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.product-row:hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    transform: translateY(-2px);
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.hover-suggestion:hover {
    background-color: #f8f9fa;
    transform: translateX(5px);
    transition: all 0.3s ease;
}

.sticky-top {
    position: sticky;
    z-index: 10;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
}

.bg-gradient-info {
    background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%) !important;
}

.empty-state {
    padding: 2rem 0;
}

.product-image {
    transition: transform 0.3s ease;
}

.product-row:hover .product-image {
    transform: scale(1.05);
}
</style>

<script>
function updateQuantity(button, change, maxStock) {
    const form = button.closest('form');
    const input = form.querySelector('input[name="cantidad"]');
    let newValue = parseInt(input.value) + change;
    
    // Validar l√≠mites
    if (newValue < 1) newValue = 1;
    if (newValue > maxStock) newValue = maxStock;
    
    input.value = newValue;
    form.submit();
}

// Efectos visuales para los botones de cantidad
document.addEventListener('DOMContentLoaded', function() {
    const quantityButtons = document.querySelectorAll('.btn-outline-secondary');
    quantityButtons.forEach(button => {
        button.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1)';
        });
        button.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
});
</script>
{% endblock %}